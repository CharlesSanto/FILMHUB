@model FILMHUB.ViewModel.ProfileViewModel

@{
    ViewData["Title"] = "Perfil";
    var userName = Context.Session.GetString("UserName");
}

<section class="pf-page">

    <!-- HEADER -->
    <div class="pf-header">

        <div class="pf-user">
            <img
                class="pf-avatar"
                src="~/img/temp-profile-photo-removebg-preview.png"
                alt="Foto do perfil" />

            <div class="pf-user-info">
                <h1 class="pf-username">@userName</h1>

                <a asp-controller="Auth"
                   asp-action="Settings"
                   class="pf-edit">
                    Editar perfil
                </a>
            </div>
        </div>

        <div class="pf-stats">
            <div class="pf-stat">
                <span class="pf-stat-number">@Model.Reviews.UserMovies.Count</span>
                <span class="pf-stat-label">Filmes</span>
            </div>

            <div class="pf-divider"></div>

            <div class="pf-stat">
                <span class="pf-stat-number">
                    @Model.Reviews.UserMovies.Count(r => r.WatchedAt?.Year == 2025)
                </span>
                <span class="pf-stat-label">Este ano</span>
            </div>
        </div>

    </div>

    <!-- RECENTES -->
    <section class="pf-updates">
        <h2>Atualizações recentes</h2>
        <hr />

        <div class="pf-movie-grid">
            @foreach (var movie in Model.Reviews.Movies.Take(4))
            {
                <article class="pf-movie-card">
                    <a asp-controller="Home"
                       asp-action="MovieDetails"
                       asp-route-id="@movie.Id">
                        <img class="pf-movie-poster lazyload"
                             loading="lazy"
                             src="@($"https://image.tmdb.org/t/p/w300{movie.PosterPath}")"
                             alt="@movie.Title" />
                    </a>
                </article>
            }
        </div>
    </section>

    <!-- REVIEWS -->
    @if (Model.Reviews.UserMovies.Any())
    {
        <section class="pf-reviews">
            <h2>Avaliações recentes</h2>
            <hr />

            @foreach (var review in Model.Reviews.UserMovies
                       .Where(r => !string.IsNullOrEmpty(r.Review))
                       .Take(4))
            {
                var stars = (int)Math.Round((review.Rating ?? 0) / 2);

                <article class="pf-review-card">

                    <div class="pf-review-poster">
                        @foreach (var movie in Model.Reviews.Movies.Where(m => m.Id == review.MovieId))
                        {
                            <a asp-controller="Home"
                               asp-action="MovieDetails"
                               asp-route-id="@movie.Id">
                                <img class="lazyload"
                                     loading="lazy"
                                     src="@($"https://image.tmdb.org/t/p/w500{movie.PosterPath}")"
                                     alt="@movie.Title" />
                            </a>
                        }
                    </div>

                    <div class="pf-review-content">

                        @foreach (var movie in Model.Reviews.Movies.Where(m => m.Id == review.MovieId))
                        {
                            <h3 class="pf-review-title">@movie.Title</h3>
                        }

                        <div class="pf-review-meta">
                            <div class="pf-stars">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <span class="pf-star @(i <= stars ? "pf-star-filled" : "")">★</span>
                                }
                            </div>

                            <span class="pf-review-date">
                                Avaliado em @(review.WatchedAt?.ToString("dd/MM/yyyy") ?? "-")
                            </span>
                        </div>

                        <p class="pf-review-text">@review.Review</p>

                    </div>
                </article>
            }
        </section>
    }

</section>

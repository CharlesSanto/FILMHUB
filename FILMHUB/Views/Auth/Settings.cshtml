@model FILMHUB.DTO.UpdateUserDto

@{
    ViewData["Title"] = "Configurações";
}

<section class="account-page">

    <h1 class="account-title">Configurações</h1>
    <hr />

    <div class="account-layout">

        <!-- PERFIL -->
        <form method="post"
              asp-controller="Auth"
              asp-action="UpdateUser"
              class="account-form"
              novalidate>

            <h2 class="account-section">Perfil</h2>

            <div class="account-field">
                <label asp-for="Name"></label>
                <input asp-for="Name" type="text" class="account-input" />
            </div>

            <div class="account-field">
                <label asp-for="Email"></label>
                <input asp-for="Email" type="email" class="account-input" />
                <span asp-validation-for="Email" class="account-error"></span>
            </div>

            <button type="submit" class="account-btn-main">
                Salvar mudanças
            </button>

        </form>

        <!-- SENHA -->
        <form method="post"
              asp-controller="Auth"
              asp-action="ChangePassword"
              class="account-form"
              id="changePasswordForm">

            <h2 class="account-section">Alterar senha</h2>

            <div class="account-field">
                <label asp-for="CurrentPassword">Senha atual</label>
                <input asp-for="CurrentPassword" type="password" class="account-input" />
                <span id="currentPasswordError"
                      asp-validation-for="CurrentPassword"
                      class="account-error">
                    @ViewBag.PasswordError
                </span> 
            </div>

            <div class="account-field">
                <label asp-for="Password">Senha</label>
                <input asp-for="Password" type="password" class="account-input" />
                <span asp-validation-for="Password" class="account-error"></span>
            </div>

            <div class="account-field">
                <label asp-for="ConfirmPassword">Confirmar senha</label>
                <input asp-for="ConfirmPassword" type="password" class="account-input" />
                <span asp-validation-for="ConfirmPassword" class="account-error"></span>
            </div>

            <button type="submit" class="account-btn-main">
                Salvar mudanças
            </button>

        </form>

    </div>

    <hr />

    <!-- DANGER -->
    <section class="account-danger">
        <h2 class="account-section">Zona de perigo</h2>
        <p>Essa ação é permanente e não pode ser desfeita.</p>

        <button id="open-delete-dialog" class="account-btn-danger">
            Deletar minha conta
        </button>
    </section>

    <!-- MODAL -->
    <dialog id="delete-dialog" class="account-dialog">

        <h1>Excluir conta</h1>

        <p>
            Tem certeza de que deseja excluir sua conta?<br />
            Esta ação é permanente e não poderá ser desfeita.
        </p>

        <div class="account-dialog-actions">
            <button id="close-delete-dialog" class="account-btn-cancel">
                Cancelar
            </button>

            <form method="post" asp-action="DeleteUser">
                <button class="account-btn-delete">
                    Deletar minha conta
                </button>
            </form>
        </div>

    </dialog>

</section>


@section Scripts {
    <script src="~/js/validation.js"></script>
    
    
    <script>
        const dialog = document.getElementById('delete-dialog');
        const openBtn = document.getElementById('open-delete-dialog');
        const closeBtn = document.getElementById('close-delete-dialog');

        openBtn.addEventListener('click', () => dialog.showModal());
        closeBtn.addEventListener('click', () => dialog.close());
    </script>
    
    <script>
        document.getElementById("changePasswordForm")
            .addEventListener("submit", async function (e) {
    
            e.preventDefault();
    
            const errorSpan = document.getElementById("currentPasswordError");
            errorSpan.textContent = "";
    
            const formData = new FormData(this);
    
            const response = await fetch("/Auth/ChangePassword", {
                method: "POST",
                body: formData
            });
    
            if (!response.ok) {
                const error = await response.json();
                if (error.field === "CurrentPassword") {
                    errorSpan.textContent = error.message;
                }
                return;
            }
    
            alert("Senha alterada com sucesso!");
            this.reset();
        });
    </script>
}